<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>AppRouter Test</title>
  <style>
    :root {
      --bg: #0d1117;
      --bg-card: #161b22;
      --border: #30363d;
      --text: #e6edf3;
      --text-muted: #8b949e;
      --accent: #58a6ff;
      --green: #3fb950;
      --orange: #f0883e;
      --font: 'Inter', -apple-system, sans-serif;
      --font-mono: 'SF Mono', 'Fira Code', monospace;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: var(--font); background: var(--bg); color: var(--text); padding: 32px; }
    h1 { font-size: 20px; margin-bottom: 16px; }
    h2 { font-size: 14px; color: var(--text-muted); margin: 16px 0 8px; text-transform: uppercase; letter-spacing: 0.05em; }

    nav, .links {
      display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap;
    }
    nav button {
      font-family: var(--font); font-size: 13px; font-weight: 500;
      padding: 6px 14px; border-radius: 6px; border: 1px solid var(--border);
      background: var(--bg-card); color: var(--text); cursor: pointer;
    }
    nav button:hover { border-color: var(--accent); color: var(--accent); }
    nav button.active { background: var(--accent); border-color: var(--accent); color: #fff; }
    .links a {
      font-family: var(--font-mono); font-size: 13px;
      padding: 6px 14px; border-radius: 6px; border: 1px solid var(--border);
      background: var(--bg-card); color: var(--green); text-decoration: none;
    }
    .links a:hover { border-color: var(--green); }

    .card {
      background: var(--bg-card); border: 1px solid var(--border);
      border-radius: 8px; padding: 16px; margin-bottom: 16px;
    }
    .card .label { font-size: 11px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 4px; }
    .card .value { font-family: var(--font-mono); font-size: 14px; color: var(--accent); }

    #log {
      font-family: var(--font-mono); font-size: 12px; color: var(--text-muted);
      background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px;
      padding: 12px; max-height: 300px; overflow-y: auto; white-space: pre-wrap;
    }

    .guard-toggle {
      display: flex; align-items: center; gap: 8px; margin-bottom: 16px;
      font-size: 13px; color: var(--text-muted);
    }
    .guard-toggle input { accent-color: var(--accent); }
  </style>
</head>
<body>
  <h1>üõ§Ô∏è AppRouter Test</h1>

  <h2>Programmatic (JS)</h2>
  <nav id="nav">
    <button onclick="navigate('home')">Home</button>
    <button onclick="navigate('about')">About</button>
    <button onclick="navigate('user', {id: '42'})">User #42</button>
    <button onclick="navigate('user', {id: '99'})">User #99</button>
    <button onclick="navigate('user', {id: '42', tab: 'posts', verbose: true})">User #42 + params</button>
    <button onclick="navigate('settings')">Settings</button>
    <button onclick="test404()">404 Test</button>
  </nav>

  <h2>HTML Links (intercepted)</h2>
  <div class="links" id="links">
    <a href="/">/</a>
    <a href="/about">/about</a>
    <a href="/users/42">/users/42</a>
    <a href="/users/99">/users/99</a>
    <a href="/users/42?tab=posts&verbose">/users/42?tab=posts&verbose</a>
    <a href="/settings">/settings</a>
    <a href="/unknown/path">/unknown/path</a>
  </div>

  <div class="guard-toggle">
    <input type="checkbox" id="guard-enabled">
    <label for="guard-enabled">Enable auth guard (blocks "Settings" route ‚Üí redirects to "Home")</label>
  </div>

  <h2>Current State</h2>
  <div class="card">
    <div class="label">Route</div>
    <div class="value" id="current-route">‚Äî</div>
  </div>
  <div class="card">
    <div class="label">Options / Params</div>
    <div class="value" id="current-options">‚Äî</div>
  </div>
  <div class="card">
    <div class="label">Title</div>
    <div class="value" id="current-title">‚Äî</div>
  </div>
  <div class="card">
    <div class="label">URL</div>
    <div class="value" id="current-url">‚Äî</div>
  </div>

  <h2>Event Log</h2>
  <div id="log"></div>

  <script type="module">
    import { AppRouter, PubSub } from '../core/index.js';

    const logEl = document.getElementById('log');
    function log(msg) {
      let ts = new Date().toLocaleTimeString();
      logEl.textContent = `[${ts}] ${msg}\n` + logEl.textContent;
    }

    // ‚îÄ‚îÄ Route map with path patterns ‚îÄ‚îÄ
    const ctx = AppRouter.initRoutingCtx('R', {
      home:     { pattern: '/',            title: 'Home',         default: true },
      about:    { pattern: '/about',       title: 'About' },
      user:     { pattern: '/users/:id',   title: 'User Profile' },
      settings: { pattern: '/settings',    title: 'Settings',
                  load: () => {
                    log('‚è≥ Lazy loading settings module...');
                    return new Promise((r) => setTimeout(() => {
                      log('‚úÖ Settings module loaded');
                      r();
                    }, 500));
                  }
                },
      notFound: { pattern: '/404',         title: 'Not Found',    error: true },
    });

    // ‚îÄ‚îÄ Guard ‚îÄ‚îÄ
    let guardUnsub = null;
    document.getElementById('guard-enabled').addEventListener('change', (e) => {
      if (e.target.checked) {
        guardUnsub = AppRouter.beforeRoute((to, from) => {
          log(`üõ°Ô∏è Guard: ${from?.route || 'null'} ‚Üí ${to.route}`);
          if (to.route === 'settings') {
            log('üö´ Guard blocked settings! Redirecting to home.');
            return 'home';
          }
        });
        log('üõ°Ô∏è Auth guard enabled');
      } else {
        guardUnsub?.();
        guardUnsub = null;
        log('üõ°Ô∏è Auth guard disabled');
      }
    });

    // ‚îÄ‚îÄ Subscribe to route changes ‚îÄ‚îÄ
    ctx.sub('route', (route) => {
      document.getElementById('current-route').textContent = route || '‚Äî';
      log(`üìç Route changed: ${route}`);

      // Highlight active nav button
      document.querySelectorAll('#nav button').forEach((btn) => {
        btn.classList.remove('active');
      });
    });

    ctx.sub('options', (opts) => {
      document.getElementById('current-options').textContent = opts ? JSON.stringify(opts) : '‚Äî';
    });

    ctx.sub('title', (title) => {
      document.getElementById('current-title').textContent = title || '‚Äî';
    });

    // Update URL display on any state change
    let updateUrl = () => {
      document.getElementById('current-url').textContent = window.location.pathname + window.location.search;
    };
    ctx.sub('route', updateUrl);

    // ‚îÄ‚îÄ Navigation function ‚îÄ‚îÄ
    window.navigate = function(route, options = {}) {
      log(`üîó navigate('${route}', ${JSON.stringify(options)})`);
      AppRouter.navigate(route, options);
      updateUrl();
    };

    // ‚îÄ‚îÄ 404 test: push unknown path, then notify ‚îÄ‚îÄ
    window.test404 = function() {
      log('üîó pushState ‚Üí /unknown/path');
      window.history.pushState(null, '', '/unknown/path');
      AppRouter.notify();
      updateUrl();
    };

    // ‚îÄ‚îÄ Link interception ‚îÄ‚îÄ
    document.getElementById('links').addEventListener('click', (e) => {
      let a = e.target.closest('a');
      if (!a) return;
      e.preventDefault();
      let url = new URL(a.href);
      log(`üîó <a href="${url.pathname}${url.search}">`);
      window.history.pushState(null, '', url.pathname + url.search);
      AppRouter.notify();
      updateUrl();
    });

    log('üöÄ Router initialized');
    updateUrl();
  </script>
</body>
</html>
